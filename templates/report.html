{% extends "base.html" %}
{% block content %}
<div class="card">
    <!-- Header -->
    <div
        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
        <div>
            <h2 style="color:var(--primary); margin:0;">
                <i class="fas fa-user"></i> {{ staff_name }}
            </h2>
            <p style="color:var(--text-sub); font-size:0.85rem; margin:5px 0 0;">
                {{ start_date }} ã€œ {{ end_date }} ã®æ´»å‹•ãƒ¬ãƒãƒ¼ãƒˆ
            </p>
        </div>
        <a href="/" class="btn-secondary" style="text-decoration:none; padding:8px 16px;">
            <i class="fas fa-arrow-left"></i> æˆ»ã‚‹
        </a>
    </div>

    <!-- Stats Summary -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:10px; margin-bottom:20px;">
        <div
            style="background:linear-gradient(135deg, #0ea5e9, #0284c7); color:white; padding:15px; border-radius:12px; text-align:center;">
            <div style="font-size:1.8rem; font-weight:bold;">{{ total_count }}</div>
            <div style="font-size:0.75rem; opacity:0.9;">ç·æ´»å‹•æ•°</div>
        </div>
        {% if mass_email_count > 0 %}
        <div
            style="background:linear-gradient(135deg, #8b5cf6, #7c3aed); color:white; padding:15px; border-radius:12px; text-align:center;">
            <div style="font-size:1.4rem; font-weight:bold;">{{ mass_email_count }}</div>
            <div style="font-size:0.7rem; opacity:0.9;">ä¸€æ–‰ãƒ¡ãƒ¼ãƒ«</div>
        </div>
        {% endif %}
        {% for type, count in activity_counts.items() %}
        <div style="background:#f1f5f9; padding:12px; border-radius:10px; text-align:center;">
            <div style="font-size:1.2rem; font-weight:bold; color:var(--primary);">{{ count }}</div>
            <div style="font-size:0.65rem; color:var(--text-sub); line-height:1.2;">{{ type[:8] }}{% if type|length > 8
                %}...{% endif %}</div>
        </div>
        {% endfor %}
    </div>

    <!-- AI Summary -->
    <div
        style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); border:1px solid #86efac; border-radius:12px; padding:15px; margin-bottom:20px;">
        <h3 style="color:#16a34a; margin:0 0 10px; font-size:0.95rem;">
            <i class="fas fa-robot"></i> AIè¦ç´„
        </h3>
        <div style="color:#166534; font-size:0.9rem; line-height:1.6; white-space:pre-line;">{{ summary.summary or
            summary.flow or "è¦ç´„ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" }}</div>

        {% if summary.highlights %}
        <div style="margin-top:15px; padding-top:12px; border-top:1px solid #86efac;">
            <div style="font-weight:bold; color:#16a34a; font-size:0.85rem; margin-bottom:5px;">âœ¨ ãƒã‚¤ãƒ©ã‚¤ãƒˆ</div>
            <div style="color:#166534; font-size:0.85rem; white-space:pre-line;">{{ summary.highlights }}</div>
        </div>
        {% endif %}

        {% if summary.concerns and summary.concerns != "ç‰¹ã«ãªã—" %}
        <div
            style="margin-top:12px; padding-top:10px; border-top:1px solid #fde047; background:#fffbeb; margin:-15px; margin-top:10px; padding:12px 15px; border-radius:0 0 12px 12px;">
            <div style="font-weight:bold; color:#ca8a04; font-size:0.85rem; margin-bottom:5px;">âš ï¸ æ°—ã«ãªã‚‹ç‚¹</div>
            <div style="color:#a16207; font-size:0.85rem; white-space:pre-line;">{{ summary.concerns }}</div>
        </div>
        {% endif %}

        {% if summary.mass_email_note %}
        <div
            style="margin-top:12px; padding:10px 15px; background:#f1f5f9; border-radius:8px; font-size:0.8rem; color:var(--text-sub);">
            ğŸ“§ {{ summary.mass_email_note }}
        </div>
        {% endif %}
    </div>

    <!-- Activity Details (Collapsible) -->
    <div>
        <button onclick="toggleDetails()" id="detailsToggle"
            style="width:100%; background:#f8fafc; border:2px dashed #cbd5e1; border-radius:10px; padding:12px; color:var(--text-sub); font-weight:bold; cursor:pointer; transition:all 0.2s;">
            <i class="fas fa-list"></i> è©³ç´°ä¸€è¦§ã‚’è¡¨ç¤º ({{ individual_count }}ä»¶)
        </button>

        <div id="detailsList" style="display:none; margin-top:15px;">
            {% for activity in activities %}
            <div
                style="background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin-bottom:10px; border-left:4px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                    <div>
                        <span
                            style="background:var(--primary); color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:bold;">{{
                            activity.date }}</span>
                        <span style="color:var(--text-sub); font-size:0.8rem; margin-left:8px;">{{ activity.type
                            }}</span>
                    </div>
                </div>
                <div style="font-weight:bold; color:#1e293b; margin-bottom:6px;">{{ activity.client_name }}</div>
                {% if activity.content %}
                <div
                    style="color:var(--text-sub); font-size:0.85rem; line-height:1.5; white-space:pre-line; background:#f8fafc; padding:10px; border-radius:8px; max-height:100px; overflow-y:auto;">
                    {{ activity.content[:300] }}{% if activity.content|length > 300 %}...{% endif %}</div>
                {% endif %}
                {% if activity.next_action %}
                <div style="margin-top:8px; font-size:0.8rem; color:#0284c7;">
                    <i class="fas fa-arrow-right"></i> æ¬¡å›: {{ activity.next_action }}
                    {% if activity.next_date %}({{ activity.next_date }}){% endif %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <p style="text-align:center; color:var(--text-sub);">ã“ã®æœŸé–“ã®æ´»å‹•è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function toggleDetails() {
        const list = document.getElementById('detailsList');
        const btn = document.getElementById('detailsToggle');
        if (list.style.display === 'none') {
            list.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-up"></i> è©³ç´°ä¸€è¦§ã‚’é–‰ã˜ã‚‹';
            btn.style.background = '#e0f2fe';
            btn.style.borderStyle = 'solid';
            btn.style.borderColor = 'var(--primary)';
            btn.style.color = 'var(--primary)';
        } else {
            list.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-list"></i> è©³ç´°ä¸€è¦§ã‚’è¡¨ç¤º ({{ total_count }}ä»¶)';
            btn.style.background = '#f8fafc';
            btn.style.borderStyle = 'dashed';
            btn.style.borderColor = '#cbd5e1';
            btn.style.color = 'var(--text-sub)';
        }
    }
</script>
{% endblock %}