{% extends "base.html" %}
{% block content %}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0; font-size:1.2rem; color:var(--primary);">
            <i class="fas fa-history"></i> {{ client_name }} の履歴
        </h2>
        <a href="/" class="btn-secondary" style="padding:5px 10px; font-size:0.9rem;">閉じる</a>
    </div>

    <!-- AI Summary Box -->
    <div
        style="background:#f0f9ff; border-left:4px solid var(--primary); padding:15px; border-radius:4px; margin-bottom:20px;">
        <h3 style="margin-top:0; font-size:1rem; color:#0369a1;"><i class="fas fa-robot"></i> AI要約 (直近5件)</h3>

        <div style="margin-bottom:10px;">
            <strong style="color:#555; font-size:0.9rem;">これまでの流れ:</strong>
            <p style="margin:5px 0; font-size:0.95rem; line-height:1.6; white-space: pre-line;">{{ summary.flow }}</p>
        </div>

        <div style="background:white; padding:10px; border-radius:6px; border:1px solid #bae6fd;">
            <strong style="color:#0284c7; font-size:0.9rem;">直近の状況・ネクストステップ:</strong>
            <p style="margin:5px 0; font-weight:bold; color:#333;">{{ summary.latest_status }}</p>
        </div>
    </div>

    <!-- Records List -->
    <h3 style="font-size:1rem; border-bottom:1px solid #eee; padding-bottom:5px;">直近のやり取り</h3>

    {% if not records %}
    <p style="color:#888;">履歴が見つかりませんでした。</p>
    {% else %}
    <div style="display:flex; flex-direction:column; gap:15px;">
        {% for r in records %}
        <div style="border:1px solid #eee; border-radius:8px; padding:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem;">
                <span style="font-weight:bold; color:var(--primary);">{{ r.date }}</span>
                <span style="background:#eee; padding:2px 8px; border-radius:4px; font-size:0.8rem;">{{ r.type }}</span>
            </div>
            <div style="font-size:0.85rem; color:#666; margin-bottom:8px;">
                <i class="fas fa-user"></i> {{ r.staff }}
            </div>
            <div style="font-size:0.95rem; white-space: pre-wrap; color:#333; line-height:1.5;">{{ r.content }}</div>
            {% if r.next_action %}
            <div
                style="margin-top:8px; font-size:0.85rem; color:#d97706; background:#fffbeb; padding:5px; border-radius:4px;">
                <i class="fas fa-arrow-right"></i> 次回: {{ r.next_action }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div style="margin-top:20px; text-align:center;">
        <p class="text-sm text-gray">※これ以上過去のデータはKintoneを確認してください。</p>
        <a href="/" class="btn-primary" style="display:inline-block; width:100%; text-align:center;">
            確認完了 (記録作成へ)
        </a>
    </div>
</div>
{% endblock %}